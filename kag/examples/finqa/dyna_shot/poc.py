x = """
index=483,gold=0.09371,answer=9.37%,prediction=9.37052
index=1103,gold=0.30702,answer=30.7%,prediction=0.30702
index=1133,gold=0.4386,answer=43.9%,prediction=0.43860
index=109,gold=1.0,answer=,prediction=0.00000
index=708,gold=55.33333,answer=55.3,prediction=55.33333
index=786,gold=0.08284,answer=8%,prediction=8.28402
index=985,gold=0.17751,answer=18%,prediction=17.75148
index=277,gold=0.4655,answer=46.55,prediction=46.55029
index=861,gold=405.0,answer=405,prediction=405.00000
index=1080,gold=0.33084,answer=33.1%,prediction=0.33084
index=1114,gold=50.0,answer=50,prediction=50.00000
index=231,gold=0.29167,answer=-22%,prediction=-22.58065
index=848,gold=-0.43333,answer=-43%,prediction=-43.33333
index=296,gold=19.0,answer=19,prediction=19.00000
index=841,gold=0.52056,answer=52%,prediction=52.05599
index=915,gold=494.0,answer=494,prediction=494.00000
index=976,gold=0.49078,answer=49%,prediction=49.07754
index=2,gold=0.09864,answer=9.9%,prediction=9.86419
index=820,gold=18.75,answer=18.8,prediction=18.75000
index=86,gold=0.07756,answer=7.8%,prediction=-0.13580
index=598,gold=0.2646,answer=26.5%,prediction=0.26460
index=621,gold=0.2146,answer=21.46%,prediction=21.46000
index=931,gold=-0.0561,answer=-5.61%,prediction=-5.61000
index=153,gold=0.22045,answer=22%,prediction=22.04473
index=844,gold=0.0607,answer=6%,prediction=6.07029
index=184,gold=0.21864,answer=22%,prediction=21.86414
index=979,gold=0.1822,answer=18%,prediction=18.22034
index=1110,gold=0.00988,answer=0.99,prediction=3.32370
index=1112,gold=0.21864,answer=21.9%,prediction=27.98221
index=116,gold=28809.0,answer=28809,prediction=28809.00000
index=766,gold=0.12027,answer=12%,prediction=12.02749
index=768,gold=0.17447,answer=17.4%,prediction=46.04200
index=771,gold=0.21212,answer=21.2%,prediction=31.42536
index=504,gold=1.18519,answer=1.19,prediction=0.84375
index=748,gold=-0.02597,answer=-2.6%,prediction=-2.59740
index=946,gold=81.66667,answer=81.6,prediction=81.66667
index=954,gold=0.26341,answer=26.3%,prediction=72.00000
index=254,gold=0.11237,answer=11%,prediction=11.23690
index=407,gold=1.2,answer=1.2,prediction=1.20000
index=638,gold=0.11237,answer=11.2%,prediction=11.23690
index=839,gold=0.85714,answer=85.7%,prediction=85.71429
index=378,gold=0.2509,answer=25%,prediction=25.08952
index=695,gold=0.27301,answer=27%,prediction=27.30120
index=940,gold=179.345,answer=179.35,prediction=179.34500
index=754,gold=0.16614,answer=16.6%,prediction=16.61442
index=1012,gold=0.00971,answer=1.0%,prediction=0.97087
index=1127,gold=0.38573,answer=38.6%,prediction=373.54019
index=230,gold=-0.09785,answer=-9.7%,prediction=-9.78520
index=307,gold=0.0473,answer=4.8%,prediction=0.04730
index=1070,gold=0.17706,answer=18%,prediction=17.70601
index=1075,gold=0.17261,answer=17%,prediction=17.26058
index=560,gold=0.11813,answer=11.8%,prediction=11.81345
index=673,gold=1.1527,answer=115.27%,prediction=1.15270
index=808,gold=2.1345,answer=213.45%,prediction=213.45000
index=990,gold=1.44754,answer=1.44,prediction=1.44754
index=66,gold=0.53704,answer=54%,prediction=45.49020
index=423,gold=9.75,answer=9.75,prediction=9.75000
index=941,gold=68.0,answer=68,prediction=68.00000
index=1035,gold=27.0,answer=27,prediction=-27.00000
index=172,gold=15395.0,answer=15395,prediction=15395.00000
index=320,gold=-0.17521,answer=-18%,prediction=-17.52148
index=470,gold=5190.0,answer=5190,prediction=5190.00000
index=480,gold=-4079.0,answer=-4079,prediction=-4079.00000
index=321,gold=0.39339,answer=39.3%,prediction=39.33852
index=551,gold=0.18383,answer=18.4%,prediction=18.38296
index=1107,gold=12255264.0,answer=12255264,prediction=12255264.00000
index=1138,gold=3462694.66,answer=3462694,prediction=3462694.66000
index=352,gold=-0.0291,answer=-2.9%,prediction=-2.91031
index=468,gold=86.0,answer=86,prediction=86.00000
index=799,gold=-0.0291,answer=-2.9%,prediction=-2.91031
index=705,gold=0.35829,answer=35.8%,prediction=0.35829
index=716,gold=0.76505,answer=76.5%,prediction=76.50485
index=1005,gold=0.63055,answer=63.1%,prediction=0.63055
index=1036,gold=0.34946,answer=34.9%,prediction=34.94624
index=47,gold=0.07951,answer=8.0%,prediction=-7.95069
index=373,gold=-0.07951,answer=-8%,prediction=-7.95069
index=686,gold=765.2,answer=765.2,prediction=765.20000
index=1045,gold=-0.10819,answer=-11%,prediction=-10.81899
index=28,gold=5.8,answer=5.8,prediction=1.00000
index=601,gold=12.1,answer=12.1,prediction=-0.50000
index=849,gold=-0.07937,answer=-7.9%,prediction=-7.93651
index=46,gold=0.42889,answer=42.9%,prediction=42.88922
index=340,gold=0.26923,answer=27%,prediction=-2.30769
index=829,gold=-0.04138,answer=-4.1%,prediction=-4.13829
index=860,gold=0.29457,answer=29%,prediction=29.45736
index=440,gold=-0.20669,answer=-21%,prediction=-20.66852
index=532,gold=0.39007,answer=39%,prediction=39.00709
index=313,gold=3.0,answer=300%,prediction=6.00000
index=807,gold=0.07879,answer=7.87%,prediction=no
index=7,gold=0.11689,answer=12%,prediction=11.68932
index=85,gold=0.45049,answer=45%,prediction=45.04854
index=456,gold=5.73,answer=5.73,prediction=5.73000
index=537,gold=0.45049,answer=45%,prediction=45.04854
index=714,gold=410.08,answer=410.08,prediction=4.10080
index=739,gold=446.66667,answer=446%,prediction=446.66667
index=862,gold=1.63657,answer=1.64,prediction=0.41494
index=108,gold=2688.88889,answer=2689,prediction=no
index=272,gold=0.13785,answer=13.8%,prediction=13.78472
index=1088,gold=-29.0,answer=-29,prediction=253.00000
index=1109,gold=282.0,answer=282,prediction=282.00000
index=998,gold=-0.11404,answer=-11.4%,prediction=-0.11404
index=253,gold=0.01639,answer=1.6%,prediction=0.01639
index=270,gold=0.62121,answer=62.12%,prediction=1.62121
index=634,gold=0.01639,answer=1.64%,prediction=1.63906
index=865,gold=0.03208,answer=3.2%,prediction=3.20810
index=500,gold=298.5,answer=298.5,prediction=261.50000
index=566,gold=-0.13666,answer=-14%,prediction=-13.66603
index=623,gold=0.635,answer=.635,prediction=0.63500
index=753,gold=-0.49835,answer=-50%,prediction=-49.83462
index=14,gold=0.01714,answer=1.7%,prediction=1.71447
index=120,gold=17447.0,answer=17447,prediction=17290.00000
index=158,gold=0.01197,answer=1.2%,prediction=1.19734
index=503,gold=0.09716,answer=9.7%,prediction=0.00000
index=467,gold=65464368.8,answer=65464368.80,prediction=65464368.80000
index=130,gold=1.9667,answer=196.67,prediction=296.67
index=261,gold=1.26067,answer=126%,prediction=142.31773
index=658,gold=1.1756,answer=117.56%,prediction=N/A
index=888,gold=no,answer=no,prediction=no
index=276,gold=120.0,answer=120,prediction=120.00000
index=668,gold=0.10101,answer=10%,prediction=10.10101
index=1106,gold=-11.0,answer=-11,prediction=-11.00000
index=1121,gold=-0.1,answer=-10%,prediction=-10.00000
index=813,gold=0.46513,answer=27%,prediction=46.51337
index=846,gold=0.45876,answer=46%,prediction=45.87644
index=927,gold=57.20703,answer=57.2,prediction=57.20703
index=975,gold=0.88015,answer=88.0%,prediction=0.88015
index=51,gold=4.6,answer=4.6,prediction=38.60000
index=711,gold=1.69231,answer=1.69,prediction=1.69231
index=79,gold=2.13755,answer=213.8%,prediction=110.49000
index=80,gold=110.49,answer=110.49,prediction=99.86000
index=180,gold=0.0776,answer=7.8%,prediction=0.07760
index=273,gold=1.0762,answer=107.6%,prediction=1.07620
index=194,gold=0.86957,answer=87%,prediction=86.95652
index=227,gold=1.136,answer=1.1,prediction=1.13600
index=475,gold=5.81308,answer=5.8,prediction=5.81308
index=892,gold=149.0,answer=149,prediction=149.00000
index=759,gold=0.10345,answer=10.3%,prediction=0.10345
index=275,gold=0.47887,answer=47.9%,prediction=47.88732
index=330,gold=-13636.0,answer=-13636,prediction=-13636.00000
index=784,gold=-5781.0,answer=-5781,prediction=20963.00000
index=878,gold=-13636.0,answer=-65.1%,prediction=-65.04794
index=244,gold=-0.0333,answer=-3.3%,prediction=-3.33000
index=482,gold=0.9827,answer=98.27%,prediction=98.27000
index=62,gold=373153158.3,answer=373153150,prediction=373153158.30000
index=72,gold=0.99509,answer=99.5%,prediction=99.50884
index=569,gold=0.99509,answer=99.5%,prediction=99.50868
index=757,gold=373.15316,answer=375.15,prediction=373.15316
index=795,gold=0.00491,answer=0.491%,prediction=0.49116
index=495,gold=0.25279,answer=25%,prediction=25.27932
index=524,gold=0.2509,answer=25%,prediction=25.08952
index=580,gold=-0.05497,answer=-5%,prediction=-5.49719
index=755,gold=-0.02433,answer=-2%,prediction=-2.43269
index=902,gold=0.40558,answer=40.6%,prediction=40.55805
index=5,gold=0.06757,answer=7%,prediction=8.60749
index=324,gold=0.08607,answer=9%,prediction=-43.88817
index=264,gold=674.0,answer=674,prediction=674.00000
index=379,gold=30.87736,answer=30.9,prediction=30.87736
index=398,gold=2.5491,answer=2.55,prediction=2.59292
index=442,gold=7.68293,answer=7.7,prediction=7.66000
index=167,gold=-41.0,answer=-41,prediction=-41.00000
index=641,gold=59.5,answer=,prediction=38.37209
index=857,gold=33.0,answer=33,prediction=33.00000
index=1009,gold=283.0,answer=283,prediction=283.00000
index=23,gold=0.01741,answer=2%,prediction=1.74137
index=977,gold=0.15695,answer=16%,prediction=15.69503
index=228,gold=0.9,answer=90%,prediction=90.00000
index=306,gold=18.7,answer=18.7,prediction=18.70000
index=111,gold=-8095.0,answer=-8095,prediction=-8095.00000
index=301,gold=0.4,answer=0.4,prediction=0.40000
index=669,gold=0.5,answer=50%,prediction=0.50000
index=0,gold=94.0,answer=94,prediction=94.00000
index=144,gold=6111.0,answer=6111,prediction=5547.00000
index=241,gold=0.01639,answer=1.6%,prediction=0.01639
index=869,gold=5729.0,answer=,prediction=5675.00000
index=145,gold=0.19351,answer=19%,prediction=19.35135
index=233,gold=0.19391,answer=19%,prediction=19.39086
index=1090,gold=0.08207,answer=8.2%,prediction=8.20682
index=93,gold=85929.0,answer=85929,prediction=85929.00000
index=205,gold=0.80991,answer=81.0%,prediction=80.99112
index=1002,gold=0.25199,answer=25%,prediction=20.12709
index=1019,gold=85929.0,answer=85929,prediction=85929.00000
index=134,gold=1.56326,answer=1.56,prediction=1.56326
index=527,gold=0.38537,answer=.385,prediction=0.38537
index=692,gold=-0.3142,answer=-31.47,,prediction=-31.41994
index=713,gold=209703.0,answer=139801,prediction=139801.00000
index=269,gold=88.57527,answer=88.57,prediction=88.57527
index=549,gold=14.0,answer=14,prediction=14.00000
index=587,gold=10.38576,answer=10.4%,prediction=10.38576
index=853,gold=0.88575,answer=88.6%,prediction=88.57527
index=391,gold=1.78041,answer=1.8,prediction=1.78041
index=724,gold=67178.0,answer=67178.0,prediction=67178.00000
index=871,gold=0.12271,answer=12.2%,prediction=12.27096
index=891,gold=1375.0,answer=1375,prediction=30.00000
index=186,gold=5.08,answer=13.0%,prediction=13.01563
index=405,gold=498.0,answer=498,prediction=498.00000
index=13,gold=no,answer=no,prediction=no
index=642,gold=-125.06,answer=17.3%,prediction=0.17266
index=1043,gold=140.29,answer=140.29,prediction=no
index=342,gold=10.6,answer=10.6,prediction=-10.60000
index=722,gold=1.15217,answer=115%,prediction=-115.21739
index=933,gold=0.13423,answer=13.4%,prediction=-2.00000
index=647,gold=0.65273,answer=65.3%,prediction=65.27307
index=926,gold=0.74953,answer=7.5%,prediction=7.49529
index=171,gold=31.77215,answer=34.05,prediction=31.77215
index=216,gold=37.1,answer=37.1,prediction=37.10000
index=720,gold=0.45082,answer=45.1%,prediction=0.45082
index=993,gold=0.29434,answer=29.4%,prediction=29.43368
index=191,gold=16.43,answer=16.43,prediction=16.43000
index=392,gold=241.11,answer=241.11,prediction=241.11000
index=376,gold=0.03957,answer=3.95%,prediction=3.95683
index=732,gold=0.10482,answer=10.5%,prediction=0.10482
index=485,gold=-0.83333,answer=-83.3%,prediction=83.09742
index=726,gold=0.14167,answer=14.2%,prediction=9.47750
index=939,gold=2.87073,answer=-287%,prediction=-74.16507
index=161,gold=-9.2,answer=-9.2,prediction=-9.20000
index=801,gold=10.2,answer=,prediction=10.20000
index=55,gold=0.03825,answer=3.8%,prediction=3.82514
index=687,gold=79900.0,answer=79900,prediction=32100.00000
index=77,gold=-26.0,answer=-26,prediction=-26.00000
index=155,gold=-0.55319,answer=-55.3%,prediction=-55.31915
index=416,gold=0.34024,answer=34.0%,prediction=0.34024
index=436,gold=27.80639,answer=27.8,prediction=27.80639
index=1091,gold=0.34024,answer=34%,prediction=34.02362
index=1145,gold=27.80639,answer=$ 27.8 per share,prediction=27.80639
index=817,gold=1.48936,answer=0.15%,prediction=1.00000
index=165,gold=231341.66667,answer=231341.7,prediction=231341.66667
index=266,gold=231341.66667,answer=231341.7,prediction=231341.66667
index=626,gold=no,answer=no,prediction=no
index=181,gold=20.0,answer=20,prediction=20.00000
index=319,gold=0.81429,answer=81.4%,prediction=0.81429
index=411,gold=0.32075,answer=32.07%,prediction=32.07547
index=585,gold=17.0,answer=17,prediction=17.00000
index=26,gold=0.34807,answer=34.8%,prediction=34.80663
index=218,gold=11.8,answer=11.8,prediction=11.80000
index=859,gold=0.25532,answer=25.5%,prediction=25.53191
index=472,gold=77.65,answer=77.7,prediction=74.70000
index=960,gold=92.0,answer=92,prediction=93.00000
index=518,gold=-30.76,answer=-30.76%,prediction=-30.76000
index=603,gold=0.68498,answer=0.685,prediction=0.68498
index=812,gold=-0.5619,answer=-56.19%,prediction=100.00000
"""

import re


class FinQAEvaluate:

    def check(self, prediction: str, answer: str, exe_ans: str):
        """
        prediction和exe_ans进行比较
        """

        prediction = prediction.strip()
        try:
            # 1. 带有%号的，去除%，数值除以100
            if prediction.endswith("%"):
                prediction = prediction.strip("%")
                prediction = str(float(prediction) / 100)
        except:
            pass

        answer = answer.strip()
        exe_ans = exe_ans.strip()

        if not self.is_float(prediction):
            return prediction == exe_ans

        # 比较prediction和exe_ans完全相等
        if self.is_close_rel(exe_ans, prediction):
            return True
        elif self.is_percentage_close(exe_ans, prediction):
            return True
        elif self.is_float(answer.strip("%")) and self.is_close_rel(
            answer.strip("%"), prediction
        ):
            return True

        return False

    def is_float(self, value):
        try:
            float(value)
            return True
        except ValueError:
            return False

    def is_close_rel(self, a, b, rel_tol=1e-9):
        a, b = self.round_to_smaller_precision(a, b)
        a = float(a)
        b = float(b)
        return abs(a - b) < rel_tol * max(abs(a), abs(b))

    def is_percentage_close(self, a, b, rel_tol=1e-9):
        b = str(float(b) / 100)
        a, b = self.round_to_smaller_precision(a, b)
        a = float(a)
        b = float(b)
        return abs(a - b) < rel_tol * max(abs(a), abs(b))

    def round_to_smaller_precision(self, num1: str, num2: str) -> (str, str):
        """
        四舍五入两个数字到较小的精度。
        """

        def get_precision(num: str) -> int:
            if "." in num:
                return len(num.split(".")[1])
            return 0

        num1 = str(abs(float(num1)))
        num2 = str(abs(float(num2)))

        precision1 = get_precision(num1)
        precision2 = get_precision(num2)
        smaller_precision = min(precision1, precision2)
        rounded_num1 = round(float(num1), smaller_precision)
        rounded_num2 = round(float(num2), smaller_precision)
        return (
            f"{rounded_num1:.{smaller_precision}f}",
            f"{rounded_num2:.{smaller_precision}f}",
        )

    def is_same_sign(self, str1, str2):
        num1 = float(str1)
        num2 = float(str2)
        # 判断正负号是否相同
        return (num1 >= 0 and num2 >= 0) or (num1 < 0 and num2 < 0)


if __name__ == "__main__":
    pattern = r"^index=(.*?),gold=(.*?),answer=(.*?),prediction=(.*?)$"
    eval = FinQAEvaluate()
    right = 0
    error = 0
    for l in x.splitlines():
        if len(l) <= 0:
            continue
        matchs = re.search(pattern=pattern, string=l)
        idx = matchs.group(1).strip()
        exe_ans = matchs.group(2).strip()
        answer = matchs.group(3).strip()
        prediction = matchs.group(4).strip()
        try:
            if eval.check(prediction=prediction, answer=answer, exe_ans=exe_ans):
                right += 1
            else:
                print(l)
                error += 1
        except:
            print("**", l)
    print(right / (right + error))
